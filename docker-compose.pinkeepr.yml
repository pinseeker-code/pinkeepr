# Pinkeepr - Hardened OpenClaw Docker Compose for Umbrel/Portainer
# 
# Security features:
# - No Docker socket mount (use Portainer API if container control needed)
# - Non-root user (node:1000)
# - Read-only root filesystem with tmpfs for runtime
# - Dropped Linux capabilities
# - No new privileges
# - Tailscale-only network access (no public exposure)

services:
  pinkeepr:
    image: ghcr.io/openclaw/openclaw:latest
    container_name: pinkeepr
    hostname: pinkeepr
    
    # Security hardening (user constraint removed to fix volume permissions)
    security_opt:
      - no-new-privileges:true
    cap_drop:
      - ALL
    
    # Prevent container escape
    # NOTE: We do NOT mount /var/run/docker.sock
    # Use Portainer API with scoped token if container control is needed
    
    environment:
      HOME: /home/node
      TERM: xterm-256color
      NODE_ENV: production
      NODE_OPTIONS: "--max-old-space-size=1536"
      
      # Gateway configuration
      OPENCLAW_GATEWAY_TOKEN: ${OPENCLAW_GATEWAY_TOKEN}
      OPENCLAW_GATEWAY_MODE: local
      
      # Nostr channel (Pinkeepr's identity)
      NOSTR_PRIVATE_KEY: ${PINKEEPR_NSEC}
      
      # Ollama LLM backend (on your laptop via Tailscale)
      OLLAMA_API_KEY: ${OLLAMA_API_KEY:-ollama-local}
      OLLAMA_HOST: ${OLLAMA_HOST:-http://100.79.12.80:11434}
      
      # Default model
      OPENCLAW_MODEL: ollama/qwen2.5:3b
      
      # Optional: Portainer API for container management
      # PORTAINER_API_URL: ${PORTAINER_API_URL}
      # PORTAINER_API_TOKEN: ${PORTAINER_API_TOKEN}
    
    volumes:
      # Persistent config and state
      - pinkeepr_config:/home/node/.openclaw
      
      # Workspace for agent operations (optional)
      - pinkeepr_workspace:/home/node/.openclaw/workspace
    
    # tmpfs for runtime directories (read-only root needs writable tmp)
    tmpfs:
      - /tmp:mode=1777,size=64m
      - /home/node/.npm:mode=755,size=32m
    
    # Bind to localhost only - access via Tailscale is handled at host level
    # Security: container stays isolated, only localhost can reach the port
    ports:
      - "127.0.0.1:18789:18789"
    
    # Health check
    healthcheck:
      test: ["CMD", "node", "-e", "fetch('http://localhost:18789/health').then(r => process.exit(r.ok ? 0 : 1))"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    
    # Restart policy
    restart: unless-stopped
    
    # Resource limits (adjust based on your hardware)
    deploy:
      resources:
        limits:
          cpus: '2'
          memory: 2G
        reservations:
          cpus: '0.5'
          memory: 512M
    
    # Run the gateway with init script to fix permissions and write config
    entrypoint:
      - /bin/sh
      - -c
      - |
        # Fix ownership of config directory
        chown -R node:node /home/node/.openclaw 2>/dev/null || true
        
        # Write config file if it doesn't exist
        if [ ! -f /home/node/.openclaw/openclaw.json ]; then
          cat > /home/node/.openclaw/openclaw.json << 'EOFCONFIG'
        {
          "gateway": { "mode": "local" },
          "agents": {
            "defaults": {
              "model": { "primary": "ollama/qwen2.5:3b" }
            }
          },
          "models": {
            "providers": {
              "ollama": {
                "baseUrl": "http://100.79.12.80:11434/v1",
                "apiKey": "ollama-local",
                "api": "openai-completions",
                "models": [{
                  "id": "qwen2.5:3b",
                  "name": "Qwen 2.5 3B",
                  "reasoning": false,
                  "input": ["text"],
                  "cost": { "input": 0, "output": 0, "cacheRead": 0, "cacheWrite": 0 },
                  "contextWindow": 32768,
                  "maxTokens": 8192
                }]
              }
            }
          },
          "channels": {
            "nostr": {
              "enabled": true,
              "relays": ["ws://umbrel.technitium:4848"],
              "dmPolicy": "allowlist",
              "allowFrom": ["npub1rxuynay46qlgqf66djn82tyxzaahjj03tt3svvknr2wt6athackqjry09z"],
              "profile": {
                "name": "Pinkeepr",
                "displayName": "Pinkeepr AI",
                "about": "Personal AI assistant. Private instance."
              }
            }
          }
        }
        EOFCONFIG
          chown node:node /home/node/.openclaw/openclaw.json
        fi
        
        # Run as node user
        exec su-exec node node dist/index.js gateway --bind loopback --port 18789 --allow-unconfigured

volumes:
  pinkeepr_config:
    driver: local
  pinkeepr_workspace:
    driver: local
